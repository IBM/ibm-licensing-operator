version: '2'

tasks:
  pr-code-checks:
    displayName: Build images
    include:
      - dind
      - docker-socket
    steps:
      - name: checks-setup
        when: 'false'
      - name: detect-secrets
        when: 'true'
        include:
          - docker-socket
          - dind
      - name: unit-test
        image: icr.io/continuous-delivery/base-images/base:v1.19.0
        displayName: Build, test and publish amd64 image
        include:
          - dind
          - docker-socket
        runtimeClassName: medium
        onError: 'stopAndFail'
        env:
          ARCH: amd64
        script: |
          #!/usr/bin/env bash
          set -euo pipefail
          cd "$WORKSPACE/$(load_repo app-repo path)"

          source ./build_scripts/setup_env.sh
          source ./build_scripts/install_dependencies.sh
          source ./build_scripts/run_tests.sh
          make build-push-image

          # Archive logs:
          mkdir -p "$WORKSPACE/test-results"
          cp ./*.txt "$WORKSPACE/test-results/" 2>/dev/null || true
          cp ./cover.out "$WORKSPACE/test-results/" 2>/dev/null || true

          set_env "STAGE_UNIT_TEST_STATUS" "success"
          collect-evidence --asset-type "repo" --asset-key "app-repo" --status "success" --tool-type "misc" --evidence-type "com.ibm.unit_tests"

      - name: build-ppc64le
        image: icr.io/continuous-delivery/base-images/base:v1.19.0
        displayName: Build, test and publish ppc64le image
        include:
          - dind
          - docker-socket
        runtimeClassName: medium
        onError: 'stopAndFail'
        env:
          ARCH: ppc64le
        script: |
          #!/usr/bin/env bash
          set -euo pipefail
          cd "$WORKSPACE/$(load_repo app-repo path)"

          echo "=========================================="
          echo "Building for architecture: ppc64le"
          echo "=========================================="

          source ./build_scripts/setup_env.sh
          source ./build_scripts/install_dependencies.sh
          make build-push-image
        
      - name: build-s390x
        image: icr.io/continuous-delivery/base-images/base:v1.19.0
        displayName: Build, test and publish s390x image
        include:
          - dind
          - docker-socket
        runtimeClassName: medium
        onError: 'stopAndFail'
        env: 
          ARCH: s390x
        script: |
          #!/usr/bin/env bash
          set -euo pipefail
          cd "$WORKSPACE/$(load_repo app-repo path)"

          echo "=========================================="
          echo "Building for architecture: s390x"
          echo "=========================================="

          source ./build_scripts/setup_env.sh
          source ./build_scripts/install_dependencies.sh
          make build-push-image

      - name: create-mulitarch-manifest
        image: icr.io/continuous-delivery/base-images/base:v1.19.0
        displayName: Create multiarch manifest
        include:
          - dind
          - docker-socket
        runtimeClassName: medium
        onError: 'stopAndFail'
        script: |
          #!/usr/bin/env bash
          set -euo pipefail
          cd "$WORKSPACE/$(load_repo app-repo path)"

          source ./build_scripts/setup_env.sh
          make multiarch-image-development
      - name: compliance-checks
        when: 'false'
finally:
  code-pr-finish:
    steps:
      - name: run-stage
        when: 'false'
